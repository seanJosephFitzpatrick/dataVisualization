<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
	
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="jquery-2.2.3.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

    <title>Data visualization</title>
	
	    <style type="text/css">
        body {
            background-color: white;
        }
        
        svg {
		//center canvas
            padding: 0;
            margin: auto;
            display: block;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>

<body>

    <h1 align="center">Population of Ireland by County and Gender CSO 2011</h1>
    <form>
       
          <legend>Male Female</legend>
          <p>
             <label>Select County</label>
             <select id = "countyList" onchange="postRequest()" onchange="window.location.reload()">
			
			   
			   <option value = "Carlow">Carlow</option>
			   <option value = "Cavan">Cavan</option>
			   <option value = "Clare">Clare</option>
			   <option value = "Cork">Cork</option>
			   <option value = "Dublin">Dublin</option>
			   <option value = "Donegal">Donegal</option>
			   <option value = "Galway">Galway</option>
			   <option value = "Kerry">Kerry</option>
			   <option value = "Kildare">Kildare</option>
			   <option value = "Kilkenny">Kilkenny</option>
			   <option value = "Laoise">Laoise</option>
			   <option value = "Leitrim">Leitrim</option>
			   <option value = "Limerick">Limerick</option>
			   <option value = "Longford">Longford</option>
			   <option value = "Louth">Louth</option>
			   <option value = "Mayo">Mayo</option>
			   <option value = "Meath">Meath</option>
			   <option value = "Monaghan">Monaghan</option>
			   <option value = "North Tipperary">North Tipperary</option>
			   <option value = "Offaly">Offaly</option>		 
			   <option value = "Roscommon">Roscommon</option>
			   <option value = "Sligo">Sligo</option>
			   <option value = "South Tipperary">South Tipperary</option>
			   <option value = "Waterford">Waterford</option>
			   <option value = "Westmeath">Westmeath</option>
			   <option value = "Wexford">Wexford</option>
			   <option value = "Wicklow">Wicklow</option> 
             </select>
          </p>
       
    </form>
<button onclick="Pie()" >Pie</button>
<button onclick="Bar()" >Bar</button>

	<script type="text/javascript">
	var county = countyList.value;
function postRequest() {

	//set county list selected value
	var query;
	var val = countyList.value
	
	if (val === "Carlow") {
	
			query = {"query" : "MATCH (n:County {County:'Carlow'}) RETURN (n.Population)"};
		
	} else if (val === "Dublin") {
	
		query = {"query" : "MATCH (n:County {County:'Dublin'}) RETURN (n.Population)"};
		
		
	}
	
	//Asynchronous JavaScript and XML  - Request data qithout refreshing entire page
	$.ajax({
		//POST Request
		type: "POST",
		async: false,
		//Server url
		url: "http://gmitsoftware.cloudapp.net:7474/db/data/cypher",
		//Request JSON
		dataType: "json",
		//Cypher query
		//data: {"query" : "MATCH (n:County) RETURN DISTINCT (n.Population) LIMIT 3;"},
		//data: {"query" : "MATCH (n:County {County:'Galway'}) RETURN (n.Population)"},
		data: query,
		
		//On success call callback function
		success: callback,
		//Error function
		error: function (jqXHR, exception) {
			var msg = '';
			if (jqXHR.status == 400) {
				msg = 'Status: 400 Bad Request';
			} else if (exception === 404) {
				msg = 'Status: 404 Not Found';
			} else if (exception === 408) {
				msg = 'Status: 408 Request Timeout';
			} else if (exception === 418) {
				//type: "BREW",
				//url: https://en.wikipedia.org/wiki/Hyper_Text_Coffee_Pot_Control_Protocol,
				//accepts: "Lyons Tea",
				//datatype: "Tealeaves",
				msg = 'Im a Teapot RFC2324';
			} else {
				msg = 'Uncaught Error.\n' + jqXHR.responseText;
			}
			//Display error in console
			console.log(msg);
		}
	});//end of ajax
	
} //end of postRequest()

postRequest();

//callback function
function callback(data){
	arr = $.map(data, function(el) { return el });
	a = arr[1][0]
	b = arr[2][0]
	
}//callback

function reloadPage(){
	window.location.reload();
}

///////////////////////////////////////////////////////////////////////////////////////////////////////

/*
*This section of code below was acquired online at [https://bl.ocks.org/LiangGou/30e9af0d54e1d5287199]
*/

	var x,
        y,
		a,
		b,
		d,
		w = 920,
		h = 400,
        duration = 2000,
        delay = 500;

	//D3 color scale 10,20,20b each one contains a unique set of colors 
    var color = d3.scale.category10();
	
	//Adding an SVG element to the canvas
    var svg = d3.select("body").append("svg")
		//set width of canvas
		.attr("width", "960")
		//set height of canvas
		.attr("height", "400")
		//group SVG shapes together
		.append("g")
		
	//JavaScript data Object
	var data = [{
        Text: arr[1][0],//women
        population: a
	
		
    }, {
        Text: arr[2][0],//women
		population: b
		
    }]
      
    x = d3.scale.ordinal();

    y = d3.scale.linear();

    x.domain(data.map(function(d) {
            return d.Text;
        }))
        .rangeRoundBands([0, w], .2);

    var pie = d3.layout.pie()
        .value(function(d) {
            return d.population;
        });

    var arc = d3.svg.arc();

    y.domain([0, d3.max(data.map(function(d) {
            return d.population;
        }))])
        //.range([1500 / 4 - 20, 0]);//?????
		//.range([550, 0]);
		.range([1500 / 4 - 20, 0]);

    var g = svg.selectAll(".symbol")
        .data(function() {
            return pie(data);
        })
        .enter()
        .append("g")
        .attr("class", "symbol");

     g.append("rect")
        .style("fill", function(d) {
            return color(d.data.Text);
        })
        .attr("x", function(d){
            return x(d.data.Text);
        })
        .attr("y", function(d){
            return y(d.data.population);
			console.log(y);
        })
        .attr("width", x.rangeBand())
        .attr("height", function(d) {
                //return h - y(d.data.population);
				return h - y(d.data.population);
            });
            
    //draw bar chart first 
        
        g.append("path")
        .style("fill", function(d) {
            return color(d.data.Text);
			
        });
		//draw text
        g.append("text")
        .attr("transform", function(d){
            return "translate(" + (x(d.data.Text)+x.rangeBand()/3) + "," + (h+20) + ")";
        })
        .text(function(d) {
            return d.data.Text;
        });


		
function Pie(){

	var g = svg.selectAll(".symbol");

		g.selectAll("rect").remove();

		g.selectAll("path")
			.transition()
			.duration(duration)//takes two seconds duration
			.tween("arc", animate);
			
		j=2;//set variables j = 2
		animate();//call animate function
   
}//Pie()

function Bar(){
	var g = svg.selectAll(".symbol");

		g.selectAll("rect").remove();

		g.selectAll("path")
			.transition()
			.duration(duration)//takes two seconds duration
			.tween("arc", animate);
			
		j=1;//set variable j = 1
		animate();//call animat function
   
}//Bar()  

function animate(d) {

	var path = d3.select(this),
		text = d3.select(this.parentNode).select("text"),
		x0 = x(d.data.Text),
		y0 = h - y(d.data.population); //initial height

	return function(t) {
	if(j == 1)//if true to bar else to pie
		t = 1-t;
		var r = h / 2 / Math.min(1, t + 1e-3),
			//a is stepping factor, starting from 1 to 0,
			//as the timer t goes.
			//A simper alternative: a = 1 - t;
			a = Math.cos(t * Math.PI / 2),
			xx = (-r + (a) * (x0 + x.rangeBand()) + (1 - a) * (w + h) / 2),
			yy = ((a) * h + (1 - a) * h / 2),
			f = {
				innerRadius: (r - x.rangeBand() / (2 - a)) * a,
				//innerRadius: 80,
				//pie chart: (r - x.rangeBand() / (2 - a)) * a,
				outerRadius: r,
				startAngle: a * (Math.PI / 2 - y0 / r) + (1 - a) * d.startAngle,
				endAngle: a * (Math.PI / 2) + (1 - a) * d.endAngle
			};//f


		path.attr("transform", "translate(" + xx + "," + yy + ")");
		path.attr("d", arc(f));
		text.attr("transform", "translate(" + arc.centroid(f) + ")translate(" + xx + "," + yy + ")rotate(" + ((f.startAngle + f.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
	};//return()
}//animate()		

	</script>
</body>

</html>